
<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

<link rel="manifest" href="./manifest.webmanifest" />
<meta name="theme-color" content="#f5f5f7" />

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="Krisy" />
<link rel="apple-touch-icon" href="./icons/icon-192.png" />

  <meta charset="UTF-8" />
  <title>Invoice Record</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body{
      margin:0;
      background:#f5f5f5;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
      color:#111;
    }
    .wrap{
      max-width:900px;
      margin:24px auto;
      padding:16px;
    }
    .card{
      background:#fff;
      border-radius:16px;
      padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
    }
    h1{
      font-size:16px;
      margin:0 0 12px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th,td{
      padding:10px 8px;
      border-bottom:1px solid rgba(0,0,0,.1);
      text-align:left;
    }
    th{
      color:#666;
      font-weight:600;
      font-size:12px;
    }
    .btn{
      padding:6px 10px;
      border-radius:8px;
      border:1px solid rgba(0,0,0,.2);
      background:#fff;
      cursor:pointer;
      font-size:12px;
    }
    .btn-danger{
      border-color:#e11d48;
      color:#e11d48;
    }
    .btn-cancel{
      border-color:rgba(0,0,0,.2);
      color:#111;
      margin-left:8px;
      display:none;
    }
    .empty{
      color:#777;
      font-size:13px;
      padding:12px 0;
      }


/* ===== Record é¡µï¼šé¡¶éƒ¨å®‰å…¨åŒºï¼ˆå’Œ invoice ä¸€æ ·ï¼‰ ===== */
:root{
  --safeTop: 50px;   /* å’Œ invoice ä¿æŒä¸€è‡´ */
}

.top-safe{
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: var(--safeTop);
  background: #fff;
  z-index: 9998;
}

/* å…³é”®ï¼šæ•´ä¸ªé¡µé¢å†…å®¹ä¸‹ç§»ï¼Œæ°¸è¿œä¸è¢« Back å‹ä½ */
body{
  padding-top: var(--safeTop);
}

/* Record çš„ç™½è‰²å¡ç‰‡ï¼Œè½»å¾®ä¸‹æ²‰ä¸€ç‚¹ */
.card{
  margin-top: 14px;
}



  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

</head>

<body>
    <div class="top-safe"></div>
    <button
  id="backHomeBtn"
  onclick="location.href='index.html'"
  style="
    position: fixed;
    top: 14px;
    left: 14px;
    z-index: 9999;

    background: rgba(245,245,247,.92);
    border: 1px solid rgba(0,0,0,.12);
    color:#1d1d1f;

    border-radius:999px;
    padding:10px 14px;
    font-weight:600;
    font-size:14px;
    cursor:pointer;

    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 6px 18px rgba(0,0,0,.12);
  "
>
  â† Back
</button>
<button id="driveLoginBtn"
  style="
    position: fixed;
    top: 14px;
    left: 92px;
    z-index: 9999;
    background: rgba(245,245,247,.92);
    border: 1px solid rgba(0,0,0,.12);
    color:#1d1d1f;
    border-radius:999px;
    padding:10px 12px;
    font-weight:600;
    font-size:14px;
    cursor:pointer;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  "
>â˜ï¸</button>

<span id="driveDot"
  style="
    position: fixed;
    top: 18px;
    left: 132px;
    z-index: 10000;
    width: 10px;
    height: 10px;
    border-radius: 999px;
    background: #ef4444; /* red default */
  "
></span>



  <div class="wrap">
    <div class="card">
      <h1>Invoice Record</h1>

      <table>
        <thead>
          <tr>
            <th style="width:180px;">Date</th>
            <th>Client</th>
            <th style="width:120px;">Amount</th>
            <th style="width:200px;">Action</th>
          </tr>
        </thead>
        <tbody id="recordBody"></tbody>
      </table>

      <div id="emptyState" class="empty" style="display:none;">
        No record yet
      </div>
    </div>
  </div>
<script src="./driveShared.js"></script>
<script>
  const KEY = "invoice_records_v1";
  const DRIVE_FILE = "invoice_records.json";

// åˆå¹¶ï¼ˆä¸è¦†ç›–ï¼‰ï¼šremote + local å»é‡åè¿”å›
function mergeRecords(localArr, remoteArr){
  const map = new Map();
  const put = (r)=>{
    if(!r) return;
    const key = `${r.time||""}|${r.client||""}|${String(r.amount||"")}`;
    if(!map.has(key)) map.set(key, r);
  };
  (Array.isArray(remoteArr)?remoteArr:[]).forEach(put);
  (Array.isArray(localArr)?localArr:[]).forEach(put);
  return Array.from(map.values()).sort((a,b)=> Date.parse(b.time) - Date.parse(a.time));
}

async function pullMergeFromDriveToLocal(){
  const remote = await DriveShared.readJson(DRIVE_FILE);
  if(!Array.isArray(remote)) return false;

  const local = loadRecords();
  const merged = mergeRecords(local, remote);
  localStorage.setItem(KEY, JSON.stringify(merged));
  return true;
}

async function pushLocalToDrive(){
  const local = loadRecords();
  await DriveShared.writeJson(DRIVE_FILE, local);
  return true;
}


async function pushFromLocalToDrive(){
  const local = loadRecords();
  await DriveShared.writeJson(DRIVE_FILE, local);
  return true;
}


  function loadRecords(){
    return JSON.parse(localStorage.getItem(KEY) || "[]");
  }

  function saveRecords(arr){
    localStorage.setItem(KEY, JSON.stringify(arr));
  }

  // è®©é¡µé¢ä¸Šâ€œåªæœ‰ä¸€è¡Œâ€å¤„äºç¡®è®¤æ€ï¼Œé¿å…è¯¯åˆ 
  function resetAllConfirmStates(){
    document.querySelectorAll('button[data-role="del"]').forEach(btn=>{
      btn.dataset.state = "idle";
      btn.textContent = "Delete";
      btn.style.background = "#fff";
      btn.style.color = "#e11d48";
      btn.style.borderColor = "#e11d48";
    });
    document.querySelectorAll('button[data-role="cancel"]').forEach(btn=>{
      btn.style.display = "none";
    });
  }

  function render(){
    const tbody = document.getElementById("recordBody");
    const empty = document.getElementById("emptyState");
    let records = loadRecords();
     records.sort((a,b)=> Date.parse(b.time) - Date.parse(a.time));
  // âœ… æœ€æ–°åœ¨å‰


    tbody.innerHTML = "";

    if(records.length === 0){
      empty.style.display = "block";
      return;
    }

    empty.style.display = "none";

    records.forEach((r, idx)=>{
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${new Date(r.time).toLocaleString()}</td>
        <td>${r.client}</td>
        <td>$${r.amount}</td>
        <td>
          <button class="btn btn-danger" data-role="del" data-i="${idx}" data-state="idle">Delete</button>
          <button class="btn btn-cancel" data-role="cancel" data-i="${idx}">Cancel</button>
        </td>
      `;

      const delBtn = tr.querySelector('button[data-role="del"]');
      const cancelBtn = tr.querySelector('button[data-role="cancel"]');

      // ç¬¬ä¸€æ¬¡ç‚¹ï¼šè¿›å…¥ç¡®è®¤æ€ï¼›ç¬¬äºŒæ¬¡ç‚¹ï¼šçœŸæ­£åˆ é™¤
      delBtn.onclick = async() => {
        const i = parseInt(delBtn.dataset.i, 10);

        if(delBtn.dataset.state === "idle"){
          // å…ˆæŠŠå…¶ä»–è¡Œçš„ç¡®è®¤æ€æ¸…æ‰ï¼Œé¿å…åŒæ—¶ç¡®è®¤å¤šè¡Œ
          resetAllConfirmStates();

          delBtn.dataset.state = "confirm";
          delBtn.textContent = "Confirm Delete";
          delBtn.style.background = "#fee2e2";
          delBtn.style.color = "#b91c1c";
          delBtn.style.borderColor = "#ef4444";
          cancelBtn.style.display = "inline-block";
          return;
        }

        // ç¬¬äºŒæ¬¡ç‚¹ï¼šåˆ é™¤
        const arr = loadRecords();
        const delIndex = arr.findIndex(x =>
        x.time === r.time && x.client === r.client && String(x.amount) === String(r.amount)
);
if(delIndex === -1) return;

arr.splice(delIndex, 1);
saveRecords(arr);
render();
try { await pushLocalToDrive(); } catch(e) { console.warn(e); }


      };

      // å–æ¶ˆï¼šå›åˆ° idle
      cancelBtn.onclick = () => {
        resetAllConfirmStates();
      };

      tbody.appendChild(tr);
    });
  }

  // ç‚¹å‡»é¡µé¢ç©ºç™½å¤„ï¼Œä¹Ÿè‡ªåŠ¨é€€å‡ºç¡®è®¤æ€ï¼ˆé˜²æ­¢ä½ å¿˜äº†ï¼‰
  document.addEventListener("click", (e)=>{
    const t = e.target;
    const insideAction = t && (t.closest && t.closest("#recordBody"));
    const isDelOrCancel = t && t.dataset && (t.dataset.role === "del" || t.dataset.role === "cancel");
    if(insideAction && isDelOrCancel) return;
    resetAllConfirmStates();
  });

  async function syncPullThenRenderThenPush(){
  // âœ… æ°¸è¿œå…ˆæ¸²æŸ“æœ¬åœ°ï¼ˆä¸ä¼šå‡ºç°â€œå¼€ç¥¨åæœ¬åœ°æ²¡è®°å½•â€ï¼‰
  render();

  // æ²¡æœ‰ token å°±ä¸è¦ä¹± pull/pushï¼ˆé¿å…è¦†ç›–/æŠ¥é”™/æ²¡ååº”ï¼‰
  try{
    await DriveShared.ensureAccessToken(false);
  }catch(e){
    // è¿˜æ²¡æˆæƒï¼šä¿æŒæœ¬åœ°å¯ç”¨ï¼Œç­‰å¾…ä½ ç‚¹äº‘æœµ
    return;
  }

  // æœ‰ tokenï¼šåˆå¹¶äº‘ç«¯ â†’ é‡æ–°æ¸²æŸ“ â†’ æ¨å›äº‘ç«¯
  try{
    await pullMergeFromDriveToLocal();
    render();
  }catch(e){
    console.warn("Drive merge pull failed:", e);
  }

  try{
    await pushLocalToDrive();
  }catch(e){
    console.warn("Drive push failed:", e);
  }
}


function setDriveDot(color){
  const dot = document.getElementById("driveDot");
  if(!dot) return;
  dot.style.background = (color==="green") ? "#22c55e" : (color==="yellow") ? "#f59e0b" : "#ef4444";
}

window.addEventListener("DOMContentLoaded", async ()=>{
  setDriveDot("yellow");

  let hasToken = false;

  try{
    // ğŸ‘ˆ å…³é”®ï¼šåªåšâ€œæ£€æŸ¥â€ï¼Œä¸å¼ºæ±‚
    await DriveShared.ensureAccessToken(false);
    hasToken = true;
    setDriveDot("green");
  }catch(e){
    // æ²¡æˆæƒï¼Œä¸è‡ªåŠ¨åŒæ­¥
    setDriveDot("red");
  }

  // âœ… æ°¸è¿œå…ˆæ˜¾ç¤ºæœ¬åœ°ï¼ˆæœ€å®‰å…¨ï¼‰
  render();

  // âœ… åªæœ‰â€œå·²æˆæƒâ€æ‰è‡ªåŠ¨åŒæ­¥
  if(hasToken){
    await syncPullThenRenderThenPush();
  }
});


 document.getElementById("driveLoginBtn").onclick = async ()=>{
  try{
    setDriveDot("yellow");
    await DriveShared.ensureAccessToken(true);   // interactive
    setDriveDot("green");
    await syncPullThenRenderThenPush();          // æˆæƒåç«‹åˆ»ï¼šåˆå¹¶+æ¨é€
    alert("Drive å·²è¿æ¥å¹¶åŒæ­¥å®Œæˆ");
  }catch(e){
    console.warn(e);
    setDriveDot("red");
    alert("Drive è¿æ¥å¤±è´¥ï¼š" + (e?.message || e));
  }
};


</script>



</body>
</html>



<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

<link rel="manifest" href="./manifest.webmanifest" />
<meta name="theme-color" content="#f5f5f7" />

<!-- iOS PWA -->
<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="default" />
<meta name="apple-mobile-web-app-title" content="Krisy" />
<link rel="apple-touch-icon" href="./krisy-icon-180.png" />

  <meta charset="UTF-8" />
  <title>Invoice Record</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    body{
      margin:0;
      background:#f5f5f5;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial;
      color:#111;
    }
    .wrap{
      max-width:900px;
      margin:24px auto;
      padding:16px;
    }
    .card{
      background:#fff;
      border-radius:16px;
      padding:18px;
      box-shadow:0 10px 30px rgba(0,0,0,.06);
    }
    h1{
      font-size:16px;
      margin:0 0 12px;
    }
    table{
      width:100%;
      border-collapse:collapse;
      font-size:13px;
    }
    th,td{
      padding:10px 8px;
      border-bottom:1px solid rgba(0,0,0,.1);
      text-align:left;
    }
    th{
      color:#666;
      font-weight:600;
      font-size:12px;
    }
    .btn{
      padding:6px 10px;
      border-radius:8px;
      border:1px solid rgba(0,0,0,.2);
      background:#fff;
      cursor:pointer;
      font-size:12px;
    }
    .btn-danger{
      border-color:#e11d48;
      color:#e11d48;
    }
    .btn-cancel{
      border-color:rgba(0,0,0,.2);
      color:#111;
      margin-left:8px;
      display:none;
    }
    .empty{
      color:#777;
      font-size:13px;
      padding:12px 0;
      }


/* ===== Record 页：顶部安全区（和 invoice 一样） ===== */
:root{
  --safeTop: 50px;   /* 和 invoice 保持一致 */
}

.top-safe{
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  height: var(--safeTop);
  background: #fff;
  z-index: 9998;
}

/* 关键：整个页面内容下移，永远不被 Back 压住 */
body{
  padding-top: var(--safeTop);
}

/* Record 的白色卡片，轻微下沉一点 */
.card{
  margin-top: 14px;
}



  </style>
  <script src="https://accounts.google.com/gsi/client" async defer></script>

</head>

<body>
    <div class="top-safe"></div>
    <button
  id="backHomeBtn"
  onclick="location.href='index.html'"
  style="
    position: fixed;
    top: 14px;
    left: 14px;
    z-index: 9999;

    background: rgba(245,245,247,.92);
    border: 1px solid rgba(0,0,0,.12);
    color:#1d1d1f;

    border-radius:999px;
    padding:10px 14px;
    font-weight:600;
    font-size:14px;
    cursor:pointer;

    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
    box-shadow: 0 6px 18px rgba(0,0,0,.12);
  "
>
  ← Back
</button>
<button id="driveLoginBtn"
  style="
    position: fixed;
    top: 14px;
    left: 92px;
    z-index: 9999;
    background: rgba(245,245,247,.92);
    border: 1px solid rgba(0,0,0,.12);
    color:#1d1d1f;
    border-radius:999px;
    padding:10px 12px;
    font-weight:600;
    font-size:14px;
    cursor:pointer;
    backdrop-filter: blur(12px);
    -webkit-backdrop-filter: blur(12px);
  "
>☁︎</button>

<span id="driveDot"
  style="
    position: fixed;
    top: 18px;
    left: 132px;
    z-index: 10000;
    width: 10px;
    height: 10px;
    border-radius: 999px;
    background: #ef4444; /* red default */
  "
></span>



  <div class="wrap">
    <div class="card">
      <h1>Invoice Record</h1>

      <table>
        <thead>
          <tr>
            <th style="width:180px;">Date</th>
            <th>Client</th>
            <th style="width:120px;">Amount</th>
            <th style="width:200px;">Action</th>
          </tr>
        </thead>
        <tbody id="recordBody"></tbody>
      </table>

      <div id="emptyState" class="empty" style="display:none;">
        No record yet
      </div>
    </div>
  </div>
<script src="./driveShared.js"></script>
<script>
  const KEY = "invoice_records_v1";
  const DRIVE_FILE = "invoice_records.json";

// 合并（不覆盖）：remote + local 去重后返回
// 合并：以 id 为主键；updatedAt 谁新用谁；支持 deleted 同步
function mergeRecords(localArr, remoteArr){
  const map = new Map();

  const put = (r)=>{
    if(!r || !r.id) return;
    const prev = map.get(r.id);
    const ru = Number(r.updatedAt || 0);
    const pu = Number(prev?.updatedAt || 0);

    if(!prev || ru >= pu){
      map.set(r.id, r);
    }
  };

  (Array.isArray(remoteArr) ? remoteArr : []).forEach(put);
  (Array.isArray(localArr) ? localArr : []).forEach(put);

  return Array.from(map.values()).sort((a,b)=> Date.parse(b.time) - Date.parse(a.time));
}



function extractArray(maybe){
  // 兼容：数组 / {records:[]} / {data:[]} / {items:[]} / null
  if(Array.isArray(maybe)) return maybe;
  if(maybe && typeof maybe === "object"){
    if(Array.isArray(maybe.records)) return maybe.records;
    if(Array.isArray(maybe.data)) return maybe.data;
    if(Array.isArray(maybe.items)) return maybe.items;
  }
  return null; // 表示“云端没有可用数组”
}

async function pullMergeFromDriveToLocal(){
  const remoteRaw = await DriveShared.readJson(DRIVE_FILE);
  const remoteArr = extractArray(remoteRaw);

  const local = loadRecords();

  // 云端还没有文件/没有数组：不做 merge，交给上层决定是否初始化 push
  if(!remoteArr){
    return { ok:false, reason:"no-remote-array", remoteRaw };
  }

  const merged = mergeRecords(local, remoteArr);
  localStorage.setItem(KEY, JSON.stringify(merged));
  return { ok:true, mergedCount: merged.length };
}


async function pushLocalToDrive(){
  const local = loadRecords();
  await DriveShared.writeJson(DRIVE_FILE, local);
  return true;
}
function normalizeRecord(r){
  if(!r || typeof r !== "object") return null;

  const timeStr = r.time || new Date().toISOString();
  const client = String(r.client || "").trim();
  const amount = String(r.amount ?? "").trim();

  // 旧数据如果没有 id：生成一个“稳定的 legacy id”
  if(!r.id){
    const t = Date.parse(timeStr) || Date.now();
    const safeClient = client.replace(/\s+/g,"_").slice(0,40);
    r.id = `legacy_${t}_${safeClient}_${amount}`;
  }

  // 软删除标记
  if(typeof r.deleted !== "boolean") r.deleted = false;

  // 更新时间：没有就取 time 的时间戳（或现在）
  if(!r.updatedAt){
    r.updatedAt = Date.parse(timeStr) || Date.now();
  }

  // time 保证存在
  r.time = timeStr;

  return r;
}


  function loadRecords(){
  const raw = JSON.parse(localStorage.getItem(KEY) || "[]");
  const arr = (Array.isArray(raw) ? raw : [])
    .map(normalizeRecord)
    .filter(Boolean);

  // 把补齐后的结构写回本地，确保以后一致
  localStorage.setItem(KEY, JSON.stringify(arr));
  return arr;
}


  function saveRecords(arr){
    localStorage.setItem(KEY, JSON.stringify(arr));
  }

  // 让页面上“只有一行”处于确认态，避免误删
  function resetAllConfirmStates(){
    document.querySelectorAll('button[data-role="del"]').forEach(btn=>{
      btn.dataset.state = "idle";
      btn.textContent = "Delete";
      btn.style.background = "#fff";
      btn.style.color = "#e11d48";
      btn.style.borderColor = "#e11d48";
    });
    document.querySelectorAll('button[data-role="cancel"]').forEach(btn=>{
      btn.style.display = "none";
    });
  }

  function render(){
    const tbody = document.getElementById("recordBody");
    const empty = document.getElementById("emptyState");
    let records = loadRecords().filter(r => !r.deleted);
    records.sort((a,b)=> Date.parse(b.time) - Date.parse(a.time));



    tbody.innerHTML = "";

    if(records.length === 0){
      empty.style.display = "block";
      return;
    }

    empty.style.display = "none";

    records.forEach((r, idx)=>{
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${new Date(r.time).toLocaleString()}</td>
        <td>${r.client}</td>
        <td>$${r.amount}</td>
        <td>
          <button class="btn btn-danger" data-role="del" data-i="${idx}" data-state="idle">Delete</button>
          <button class="btn btn-cancel" data-role="cancel" data-i="${idx}">Cancel</button>
        </td>
      `;

      const delBtn = tr.querySelector('button[data-role="del"]');
      const cancelBtn = tr.querySelector('button[data-role="cancel"]');

      // 第一次点：进入确认态；第二次点：真正删除
      delBtn.onclick = async() => {
        const i = parseInt(delBtn.dataset.i, 10);

        if(delBtn.dataset.state === "idle"){
          // 先把其他行的确认态清掉，避免同时确认多行
          resetAllConfirmStates();

          delBtn.dataset.state = "confirm";
          delBtn.textContent = "Confirm Delete";
          delBtn.style.background = "#fee2e2";
          delBtn.style.color = "#b91c1c";
          delBtn.style.borderColor = "#ef4444";
          cancelBtn.style.display = "inline-block";
          return;
        }

        // 第二次点：删除
       const arr = loadRecords();
const delIndex = arr.findIndex(x => x.id === r.id);
if(delIndex === -1) return;

// ✅ 软删除：让“删除”也能同步到 Drive
arr[delIndex].deleted = true;
arr[delIndex].updatedAt = Date.now();

saveRecords(arr);
render();
try { await pushLocalToDrive(); } catch(e) { console.warn(e); }

      };

      // 取消：回到 idle
      cancelBtn.onclick = () => {
        resetAllConfirmStates();
      };

      tbody.appendChild(tr);
    });
  }

  // 点击页面空白处，也自动退出确认态（防止你忘了）
  document.addEventListener("click", (e)=>{
    const t = e.target;
    const insideAction = t && (t.closest && t.closest("#recordBody"));
    const isDelOrCancel = t && t.dataset && (t.dataset.role === "del" || t.dataset.role === "cancel");
    if(insideAction && isDelOrCancel) return;
    resetAllConfirmStates();
  });

  async function syncPullThenRenderThenPush(){
  // 先显示本地（用户体验）
  render();

  // 自动拿 token：有缓存就用；能 silent 就 silent；拿不到就保持本地并显示黄点
let tok = null;
try{
  // 新 driveShared.js 里要有 ensureAccessTokenAuto()
  tok = await DriveShared.ensureAccessTokenAuto();
}catch(e){
  tok = null;
}

if(!tok){
  setDriveDot("yellow"); // 不是错误，只是“暂时没拿到云端 token”
  console.warn("No token (auto), skip sync for now");
  return;
}


  setDriveDot("yellow");

  // 1) pull + merge
  let pulled = false;
  try{
    const res = await pullMergeFromDriveToLocal();

    if(res.ok){
      pulled = true;
      render(); // 显示合并后的结果
    }else{
      // 云端没有文件/结构不是数组：用本地初始化云端（这一步非常关键）
      await pushLocalToDrive();
      pulled = true;
    }
  }catch(e){
    console.warn("Drive pull/merge failed:", e);
  }

  // 2) push（把最终一致结果写回云端）
  try{
    await pushLocalToDrive();
    setDriveDot("green");
  }catch(e){
    console.warn("Drive push failed:", e);
    setDriveDot("red");
  }

  if(!pulled){
    // pull 都没成功，标红更直观
    setDriveDot("red");
  }
}



function setDriveDot(color){
  const dot = document.getElementById("driveDot");
  if(!dot) return;
  dot.style.background = (color==="green") ? "#22c55e" : (color==="yellow") ? "#f59e0b" : "#ef4444";
}

window.addEventListener("DOMContentLoaded", async ()=>{
  setDriveDot("yellow"); // 初始不要用 red 吓自己
  render();              // 先本地秒开
  await syncPullThenRenderThenPush(); // 再自动尝试云端同步（内部已改为 auto token）
});

document.addEventListener("visibilitychange", async ()=>{
  if(!document.hidden){
    await syncPullThenRenderThenPush();
  }
});


 document.getElementById("driveLoginBtn").onclick = async ()=>{
  try{
    setDriveDot("yellow");
    await DriveShared.ensureAccessToken(true);   // interactive
    setDriveDot("green");
    await syncPullThenRenderThenPush();          // 授权后立刻：合并+推送
    alert("Drive 已连接并同步完成");
  }catch(e){
    console.warn(e);
    setDriveDot("red");
    alert("Drive 连接失败：" + (e?.message || e));
  }
};


</script>



</body>
</html>

